@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">

<h2>Users</h2>
<div class="card">
    <div class="card-header">
        <div class="row">
            <div class="col-md-6 offset-md-6">
                <button class="btn btn-primary float-right" id="btnAdd">+ Add</button>
            </div>
        </div>
    </div>
    <div id="user-container">
        <table class="table table-striped table-bordered" style="width:100%" id="tblUser">
            <thead class="thead-dark">
                <tr>
                    <th>Id</th>
                    <th>Email</th>
                    <th>Password</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Contact Name</th>
                    <th>Phone</th>
                    <th>Role ID</th>
                    <th>Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="addEmail">Email</label>
                        <input type="email" class="form-control" id="addEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="addPassword">Password</label>
                        <input type="password" class="form-control" id="addPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="addFirstName">First Name</label>
                        <input type="text" class="form-control" id="addFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="addLastName">Last Name</label>
                        <input type="text" class="form-control" id="addLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="addContactName">Contact Name</label>
                        <input type="text" class="form-control" id="addContactName">
                    </div>
                    <div class="form-group">
                        <label for="addPhone">Phone</label>
                        <input type="text" class="form-control" id="addPhone">
                    </div>
                    <div class="form-group">
                        <label for="addRoleId">Role ID</label>
                        <input type="number" class="form-control" id="addRoleId" required>
                    </div>
                    <div class="form-group">
                        <label for="addActive">Active</label>
                        <input type="checkbox" id="addActive">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveUser">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label for="editFirstName">First Name</label>
                        <input type="text" class="form-control" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name</label>
                        <input type="text" class="form-control" id="editLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editContactName">Contact Name</label>
                        <input type="text" class="form-control" id="editContactName">
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Phone</label>
                        <input type="text" class="form-control" id="editPhone">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateUser">Update</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $(".modal .close, .modal button.btn-secondary").click(function () {
            $(this).closest(".modal").modal("hide");
        });

        // Load users
        loadUserList();

        // Add User
        $("#btnAdd").click(function () {
            $("#addUserModal").modal("show");
        });

        $("#saveUser").click(function () {
            var user = {
                email: $("#addEmail").val(),
                password: $("#addPassword").val(),
                firstName: $("#addFirstName").val(),
                lastName: $("#addLastName").val(),
                contactName: $("#addContactName").val(),
                phone: $("#addPhone").val(),
                roleId: parseInt($("#addRoleId").val()), // Convert to int
                active: $("#addActive").is(":checked")
            };

            if (!user.email || !user.roleId || user.active === undefined) {
                alert("Email, Role ID and Active status are required fields.");
                return;
            }

            $.ajax({
                url: 'https://localhost:7135/api/Users',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(user),
                success: function (response) {
                    $("#addUserModal").modal("hide");
                    loadUserList();
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        });

        // Edit User
        $(document).on("click", ".btnEdit", function () {
            var userId = $(this).data("id");
            $.ajax({
                url: 'https://localhost:7135/api/Users/GetUserDetail/' + userId,
                type: 'GET',
                dataType: 'json',
                success: function (user) {
                    $("#editUserId").val(user.id);
                    $("#editFirstName").val(user.firstName);
                    $("#editLastName").val(user.lastName);
                    $("#editContactName").val(user.contactName);
                    $("#editPhone").val(user.phone);

                    $("#editUserModal").modal("show");
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        });

        $("#updateUser").click(function () {
            var userId = $("#editUserId").val();
            var user = {
                firstName: $("#editFirstName").val(),
                lastName: $("#editLastName").val(),
                contactName: $("#editContactName").val(),
                phone: $("#editPhone").val()
            };

            $.ajax({
                url: 'https://localhost:7135/api/Users/UpdateUser/' + userId,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(user),
                success: function (response) {
                    $("#editUserModal").modal("hide");
                    loadUserList();
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        });

        // Change status
        $(document).on("click", ".btnChangeStatus", function () {
            var userId = $(this).data("id");
            $.ajax({
                url: 'https://localhost:7135/api/Users/ChangeStatusUser/' + userId,
                type: 'POST',
                success: function (response) {
                    loadUserList();
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        });

        function loadUserList() {
            $.ajax({
                url: 'https://localhost:7135/api/Users',
                type: 'GET',
                dataType: 'json',
                success: function (users) {
                    var userContainer = $('#user-container').find('tbody');
                    userContainer.empty();

                    // Display user data in the table
                    $.each(users, function (index, user) {
                        var row = '<tr>' +
                            '<td>' + user.id + '</td>' +
                            '<td>' + user.email + '</td>' +
                            '<td>' + user.password + '</td>' +
                            '<td>' + user.firstName + '</td>' +
                            '<td>' + user.lastName + '</td>' +
                            '<td>' + user.contactName + '</td>' +
                            '<td>' + user.phone + '</td>' +
                            '<td>' + user.roleId + '</td>' +
                            '<td>' + user.active + '</td>' +
                            '<td>' +
                            '<button class="btn btn-info btnEdit" data-id="' + user.id + '">Edit</button>' +
                            ' <button class="btn btn-warning btnChangeStatus" data-id="' + user.id + '">Change Status</button>' +
                            '</td>' +
                            '</tr>';
                        userContainer.append(row);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        }
    });
</script>
